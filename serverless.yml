service: medical-appointment-scheduling
frameworkVersion: "3"

# CI/CD Pipeline: Complete test configuration completed - ready for deployment
provider:
  name: aws
  runtime: nodejs18.x
  region: ${opt:region, 'us-east-1'}
  stage: ${opt:stage, 'dev'}
  architecture: arm64
  memorySize: 512
  timeout: 30
  logRetentionInDays: ${file(config/${self:provider.stage}.yml):logging.retentionDays, 7}
  
  # Use deployment bucket from infrastructure stack via Parameter Store
  deploymentBucket:
    name: ${ssm:/medical-appointment/${self:provider.stage}/deployment/bucket}
    serverSideEncryption: AES256
  
  environment:
    STAGE: ${self:provider.stage}
    DEPLOYMENT_REGION: ${self:provider.region}
    LOG_LEVEL: ${file(config/${self:provider.stage}.yml):logging.level, 'INFO'}
    APPOINTMENTS_TABLE_NAME:
      Ref: AppointmentsTable
    APPOINTMENTS_TOPIC_ARN:
      Ref: AppointmentsTopic
    APPOINTMENTS_PE_TOPIC_ARN:
      Ref: AppointmentsPETopic
    APPOINTMENTS_CL_TOPIC_ARN:
      Ref: AppointmentsCLTopic
    APPOINTMENTS_PE_QUEUE_URL:
      Ref: AppointmentsPEQueue
    APPOINTMENTS_CL_QUEUE_URL:
      Ref: AppointmentsCLQueue
    APPOINTMENTS_COMPLETION_QUEUE_URL:
      Ref: AppointmentsCompletionQueue
    EVENTBRIDGE_BUS_NAME:
      Ref: MedicalAppointmentsEventBus
    # Use Parameter Store for configuration management
    RDS_HOST: ${ssm:/medical-appointment/${self:provider.stage}/rds/host}
    RDS_DATABASE: ${ssm:/medical-appointment/${self:provider.stage}/rds/database}
    RDS_PORT: ${ssm:/medical-appointment/${self:provider.stage}/rds/port}
    RDS_USERNAME: ${ssm:/medical-appointment/${self:provider.stage}/rds/username}
    RDS_PASSWORD: ${ssm:/medical-appointment/${self:provider.stage}/rds/password}

  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
          Resource:
            - Fn::GetAtt:
                - AppointmentsTable
                - Arn
            - Fn::Sub:
                - "${TableArn}/index/*"
                - TableArn:
                    Fn::GetAtt:
                      - AppointmentsTable
                      - Arn
        - Effect: Allow
          Action:
            - sns:Publish
          Resource:
            - Ref: AppointmentsTopic
            - Ref: AppointmentsPETopic
            - Ref: AppointmentsCLTopic
        - Effect: Allow
          Action:
            - sqs:SendMessage
            - sqs:ReceiveMessage
            - sqs:DeleteMessage
            - sqs:GetQueueAttributes
          Resource:
            - Fn::GetAtt:
                - AppointmentsPEQueue
                - Arn
            - Fn::GetAtt:
                - AppointmentsCLQueue
                - Arn
            - Fn::GetAtt:
                - AppointmentsCompletionQueue
                - Arn
        - Effect: Allow
          Action:
            - events:PutEvents
          Resource:
            - Fn::GetAtt:
                - MedicalAppointmentsEventBus
                - Arn
        - Effect: Allow
          Action:
            - rds-data:ExecuteStatement
            - rds-data:BatchExecuteStatement
          Resource: "*"

plugins:
  - serverless-esbuild
  - serverless-offline
  - serverless-prune-plugin

custom:
  esbuild:
    bundle: true
    minify: false
    sourcemap: true
    exclude:
      - aws-sdk
    target: node18
    define:
      require.resolve: undefined
    platform: node
    concurrency: 10

  prune:
    automatic: true
    number: 3

  serverless-offline:
    httpPort: 3000
    babelOptions:
      presets: ["env"]

# Functions will be defined in separate files and imported
functions:
  # Main appointment Lambda - handles API Gateway requests
  appointment:
    handler: functions/appointment/handler.main
    description: "Main appointment service for creating and retrieving appointments"
    events:
      - http:
          path: appointments
          method: post
          cors: true
      - http:
          path: appointments/{insuredId}
          method: get
          cors: true
          request:
            parameters:
              paths:
                insuredId: true

  # Peru appointment processor
  appointment-pe:
    handler: functions/appointment-pe/handler.main
    description: "Process appointments for Peru (PE) country"
    events:
      - sqs:
          arn:
            Fn::GetAtt:
              - AppointmentsPEQueue
              - Arn
          batchSize: 10

  # Chile appointment processor  
  appointment-cl:
    handler: functions/appointment-cl/handler.main
    description: "Process appointments for Chile (CL) country"
    events:
      - sqs:
          arn:
            Fn::GetAtt:
              - AppointmentsCLQueue
              - Arn
          batchSize: 10

  # Appointment completion processor
  appointment-completion:
    handler: functions/appointment-completion/handler.main
    description: "Complete appointment processing and update status"
    events:
      - sqs:
          arn:
            Fn::GetAtt:
              - AppointmentsCompletionQueue
              - Arn
          batchSize: 10

# Infrastructure as Code - Import resource definitions
resources:
  - ${file(resources/kms.yml)}
  - ${file(resources/dynamodb.yml)}
  - ${file(resources/sns.yml)}
  - ${file(resources/sqs.yml)}
  - ${file(resources/eventbridge.yml)}
  - ${file(resources/api-gateway.yml)}
  - ${file(resources/iam.yml)}

# Package configuration
package:
  patterns:
    - "!node_modules/**"
    - "!.git/**"
    - "!.vscode/**"
    - "!coverage/**"
    - "!.nyc_output/**"
    - "!.eslintrc.js"
    - "!.prettierrc"
    - "!jest.config.js"
    - "!tsconfig*.json"
